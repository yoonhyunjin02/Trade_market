<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="fragments/head :: common-head('Trade')"></th:block>
    <link rel="stylesheet" th:href="@{/css/common/product-card.css}">
    <link rel="stylesheet" th:href="@{/css/pages/trade.css}">
</head>
<body>

<!-- Header Fragment -->
<header th:replace="fragments/header :: header"></header>

<main>
    <!-- Banner Section -->
    <section class="trade-banner">
        <div class="banner-inner">
            <header class="text">
                <h1>믿을만한<br>이웃 간 중고거래</h1>
                <p>동네 주민들과 가까운 따뜻한 거래를<br>지금 경험해보세요.</p>
            </header>
            <figure class="image">
                <img src="/images/tradebanner.png" alt="중고거래 배너 이미지" />
            </figure>
        </div>
    </section>

    <!-- Product Grid Section -->
    <section class="popular-items">
        <h2 id="popular-title" th:text="${pageTitle}">중고거래 인기매물</h2>

        <div class="trade-content-container">
            <!-- 필터 폼 시작 -->
            <form method="get" th:action="@{/products}" class="trade-filter">
                <aside>
                    <!-- 필터 제목 + 초기화 버튼 -->
                    <div class="filter-header">
                        <h4>필터</h4>
                        <a th:href="@{/products}" class="reset-filter">초기화</a>
                    </div>

                    <!-- 거래 가능한 물건 보기 필터 -->
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" name="availableOnly"
                                   th:checked="${availableOnly}"
                                   onchange="this.form.submit()" />
                            거래 가능한 물건 보기
                        </label>
                    </div>

                    <!-- 게시물 정보 -->
                    <div class="filter-group">
                        <h4>게시물 정보</h4>
                        <label>
                            <input type="radio" name="sort" value="views"
                                   th:checked="${currentSort == 'views'}"
                                   onchange="this.form.submit()" />
                            조회순
                        </label>
                        <label>
                            <input type="radio" name="sort" value="chats"
                                   th:checked="${currentSort == 'chats'}"
                                   onchange="this.form.submit()" />
                            채팅순
                        </label>
                        <label>
                            <input type="radio" name="sort" value="latest"
                                   th:checked="${currentSort == 'latest'}"
                                   onchange="this.form.submit()" />
                            최신순
                        </label>
                    </div>

                    <!-- 가격 필터 -->
                    <h4>가격</h4>
                    <label>
                        <input type="radio" name="sort" value="priceAsc"
                               th:checked="${currentSort == 'priceAsc'}"
                               onchange="this.form.submit()" />
                        가격 낮은 순
                    </label>
                    <label>
                        <input type="radio" name="sort" value="priceDesc"
                               th:checked="${currentSort == 'priceDesc'}"
                               onchange="this.form.submit()" />
                        가격 높은 순
                    </label>

                    <div class="price-inputs">
                        <input type="number" name="minPrice" placeholder="최소 가격"
                               th:value="${param.minPrice}">
                        -
                        <input type="number" name="maxPrice" placeholder="최대 가격"
                               th:value="${param.maxPrice}">
                    </div>
                    <button type="submit" class="price-apply-btn">적용하기</button>

                    <!-- 카테고리 필터 -->
                    <div class="filter-group collapsible-filter">
                        <h4>카테고리</h4>

                        <!-- 전체보기 옵션 -->
                        <label>
                            <input type="radio" name="category"
                                   value=""
                                   th:checked="${categoryId == null}"
                                   onchange="this.form.submit()" />
                            전체보기
                        </label>

                        <!-- 5개만 보이기 -->
                        <div class="filter-list" id="categoryList">
                            <div th:each="category, iterStat : ${categories}"
                                 th:classappend="${iterStat.index >= 5} ? 'hidden-item'">
                                <label>
                                    <input type="radio" name="categoryId"
                                           th:value="${category.id}"
                                           th:checked="${categoryId != null and categoryId == category.id}"
                                           onchange="this.form.submit()" />

                                    <span th:text="${category.name}">카테고리 이름</span>
                                </label>
                            </div>
                        </div>

                        <!-- 더보기/접기 버튼 -->
                        <button type="button" class="toggle-btn" data-target="categoryList">더보기</button>
                    </div>

                    <!-- 위치 필터 -->
                    <div class="filter-group collapsible-filter">
                        <h4>위치</h4>
                        <div class="filter-list" id="locationList">
                            <div th:each="loc, iterStat : ${locations}"
                                 th:classappend="${iterStat.index >= 3} ? 'hidden-item'">
                                <label>
                                    <input type="radio" name="location" th:value="${loc}"
                                           th:checked="${param.location != null and param.location == loc}"
                                           onchange="this.form.submit()" />
                                    <span th:text="${loc}"></span>
                                </label>
                            </div>
                        </div>
                        <button type="button" class="toggle-btn" data-target="locationList">더보기</button>
                    </div>
                </aside>
            </form>

            <!-- 상품 목록 -->
            <div class="item-grid" id="product-container">

                <!-- 상품이 있는 경우 -->
                <div th:if="${#lists.size(products) > 0}">
                    <div th:each="product : ${products}">
                        <div th:replace="~{fragments/product-card :: productCard(${product})}"></div>
                    </div>
                </div>

                <!-- 상품이 없는 경우 -->
                <div th:if="${#lists.isEmpty(products)}" class="no-results">
                    <p>검색 결과가 없습니다.</p>
                </div>

            </div>
        </div>

        <div id="scroll-sentinel"></div>
    </section>
</main>

<!-- Floating Action Button -->
<nav>
    <a th:href="@{/products/new}" class="floating-btn" aria-label="중고 거래글 작성">거래글쓰기</a>
</nav>

<!-- Footer Fragment -->
<footer th:replace="fragments/footer :: footer"></footer>

<script th:src="@{/js/pages/trade.js}"></script>
</body>
</html>