<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅 - 당근마켓</title>
    <link rel="stylesheet" th:href="@{/css/common/common.css}">
    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/pages/chat.css}">
    <link rel="stylesheet" th:href="@{/css/pages/chat-toggle.css}">
</head>
<body>

<!-- 공통 헤더 -->
<div th:replace="~{fragments/header :: common-header}"></div>

<div class="chat-container">
    <div class="chat-area">

        <!-- 좌측 채팅 리스트 -->
        <div class="chat-list">
            <div class="chat-list-header">
                <div class="chat-list-title">
                    <h3>내 채팅</h3>
                    <span class="chat-count" th:if="${allChatRooms != null}" th:text="${#lists.size(allChatRooms)}">0</span>
                </div>
                <div class="toggle-switch-wrapper">
                    <label class="toggle-switch">
                        <span>읽지 않은 항목</span>
                        <input type="checkbox" id="toggleUnreadSwitch">
                    </label>
                </div>
            </div>

            <div class="chat-items-wrapper">
                <!-- 전체 채팅 리스트 -->
                <div id="all-chats-list" class="chat-items">
                    <!-- 채팅방이 없을 때 -->
                    <div th:if="${allChatRooms == null or #lists.isEmpty(allChatRooms)}" class="no-chats">
                        <div class="no-chats-icon">💬</div>
                        <p>아직 채팅방이 없습니다.</p>
                        <small>상품에 관심을 표시하거나<br>판매글을 올려보세요!</small>
                    </div>

                    <!-- 채팅방 목록 (Thymeleaf 반복문) -->
                    <div th:each="chatRoom : ${allChatRooms}"
                         class="chat-item"
                         th:data-room-id="${chatRoom.chatRoomId}"
                         th:data-partner-name="${chatRoom.otherUserName}"
                         th:classappend="${chatRoom.unreadCount > 0} ? 'has-unread' : ''">

                        <div class="chat-avatar">
                            <img th:src="${chatRoom.productImageUrl != null ? chatRoom.productImageUrl : '/images/mascot.png'}"
                                 th:alt="${chatRoom.otherUserName + '님의 프로필'}"
                                 onerror="this.src='/images/mascot.png'">
                        </div>

                        <div class="chat-info">
                            <div class="chat-name" th:text="${chatRoom.otherUserName}">상대방 이름</div>
                            <div class="chat-preview"
                                 th:text="${chatRoom.lastMessage != null ? chatRoom.lastMessage : '새로운 채팅방입니다.'}">
                                마지막 메시지
                            </div>
                        </div>

                        <div class="chat-meta">
                            <div class="chat-time"
                                 th:text="${chatRoom.lastMessageTime != null ? chatRoom.lastMessageTime : ''}">
                            </div>
                            <div th:if="${chatRoom.unreadCount > 0}"
                                 class="unread-count"
                                 th:text="${chatRoom.unreadCount}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 읽지 않은 채팅 리스트 -->
                <div id="unread-chats-list" class="chat-items" style="display: none;">
                    <!-- 읽지 않은 메시지가 있는 채팅방만 표시 -->
                    <div th:each="chatRoom : ${unreadChatRooms}"
                         class="chat-item has-unread"
                         th:data-room-id="${chatRoom.chatRoomId}"
                         th:data-partner-name="${chatRoom.otherUserName}">

                        <div class="chat-avatar">
                            <img th:src="${chatRoom.productImageUrl != null ? chatRoom.productImageUrl : '/images/mascot.png'}"
                                 th:alt="${chatRoom.otherUserName + '님의 프로필'}"
                                 onerror="this.src='/images/mascot.png'">
                        </div>

                        <div class="chat-info">
                            <div class="chat-name" th:text="${chatRoom.otherUserName}">상대방 이름</div>
                            <div class="chat-preview" th:text="${chatRoom.lastMessage}">마지막 메시지</div>
                        </div>

                        <div class="chat-meta">
                            <div class="chat-time"
                                 th:text="${chatRoom.lastMessageTime}">
                            </div>
                            <div class="unread-count" th:text="${chatRoom.unreadCount}"></div>
                        </div>
                    </div>

                    <!-- 읽지 않은 메시지가 없을 때 -->
                    <div th:if="${unreadChatRooms == null or #lists.isEmpty(unreadChatRooms)}"
                         class="no-unread">
                        <div class="no-unread-icon">✅</div>
                        <p>읽지 않은 메시지가 없습니다.</p>
                        <small>모든 메시지를 확인했어요!</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 우측 채팅 대화 영역 -->
        <div id="chat-conversation" class="chat-conversation" th:style="${selectedChatRoom != null ? 'display: flex;' : 'display: none;'}">

            <!-- 대화방 헤더 (상품 정보 및 상대방 정보) -->
            <div id="conversation-header" class="conversation-header">
                <!-- 상대방 정보 -->
                <div class="chat-partner-info">
                    <div class="partner-id">
                        <span id="partner-name" th:text="${selectedChatRoom != null ? selectedChatRoom.otherUserName : ''}">상대방</span>
                        <span class="online-status" id="online-status"></span>
                    </div>
                </div>

                <!-- 상품 정보 -->
                <div class="product-info" th:if="${selectedChatRoom != null}">
                    <img th:src="${selectedChatRoom.productImageUrl != null ? selectedChatRoom.productImageUrl : '/images/mascot.png'}"
                         alt="상품 이미지"
                         id="product-image"
                         onerror="this.src='/images/mascot.png'">
                    <div class="product-details">
                        <div class="product-title"
                             id="product-title"
                             th:text="${selectedChatRoom.productTitle}">상품명</div>
                        <div class="product-price"
                             id="product-price"
                             th:text="${selectedChatRoom.productPrice != null ? selectedChatRoom.productPrice + '원' : ''}">가격</div>
                    </div>
                </div>
            </div>

            <!-- 메시지 컨테이너 -->
            <div id="messages-container" class="messages-container">
                <!-- 기존 메시지들 표시 -->
                <div th:if="${selectedChatRoom != null and selectedChatRoom.messages != null}">
                    <div th:each="message : ${selectedChatRoom.messages}" class="message-wrapper">
                        <div class="message"
                             th:classappend="${message.userId == currentUser.userId ? 'sent' : 'received'}"
                             th:data-message-id="${message.chatRoomId + '_' + message.sentAt}">

                            <!-- 받은 메시지 (상대방) -->
                            <div th:if="${message.userId != currentUser.userId}" class="message received">
                                <div class="message-content" th:text="${message.content}">메시지 내용</div>
                                <div class="message-time" th:text="${message.sentAt}">시간</div>
                            </div>

                            <!-- 보낸 메시지 (나) -->
                            <div th:if="${message.userId == currentUser.userId}" class="message sent">
                                <div class="message-time" th:text="${message.sentAt}">시간</div>
                                <div class="message-content" th:text="${message.content}">메시지 내용</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 메시지가 없을 때 -->
                <div th:if="${selectedChatRoom == null or selectedChatRoom.messages == null or #lists.isEmpty(selectedChatRoom.messages)}"
                     class="no-messages">
                    <div class="no-messages-icon">💭</div>
                    <p>아직 메시지가 없습니다.</p>
                    <small>첫 메시지를 보내보세요!</small>
                </div>
            </div>

            <!-- 메시지 입력 영역 -->
            <div class="message-input-container">
                <form id="message-form">
                    <input type="hidden" id="roomId" name="roomId" value="">
                    <input type="hidden" id="assistantId" name="assistantId" value="">

                    <div class="input-wrapper">
                        <textarea class="message-input"
                                  id="messageInput"
                                  name="content"
                                  placeholder="메시지를 입력하세요..."
                                  rows="1"
                                  maxlength="1000"
                                  required></textarea>
                        <button type="submit" class="send-btn" id="sendBtn">
                            <span>전송</span>
                        </button>
                    </div>
                </form>

                <!-- 문자수 카운터 -->
                <div class="message-counter">
                    <span id="char-count">0</span>/1000
                </div>
            </div>
        </div>

        <!-- 대화방 선택 전 플레이스홀더 -->
        <div id="conversation-placeholder"
             class="conversation-placeholder"
             th:style="${selectedChatRoom == null ? 'display: flex;' : 'display: none;'}">
            <div class="placeholder-content">
                <div class="placeholder-icon">💬</div>
                <h3>채팅을 시작해보세요</h3>
                <p>왼쪽에서 대화방을 선택하거나<br>새로운 채팅을 시작해보세요!</p>
                <a th:href="@{/products}" class="start-chat-btn">상품 둘러보기</a>
            </div>
        </div>
    </div>
</div>

<!-- 공통 푸터 -->
<div th:replace="~{fragments/footer :: common-footer}"></div>

<!-- Thymeleaf 인라인 JavaScript로 서버 데이터 전달 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    // 서버에서 전달받은 데이터를 JavaScript 변수로 설정
    const currentUserId = /*[[${currentUser != null ? currentUser.userId : ''}]]*/ '';
    const currentUserName = /*[[${currentUser != null ? currentUser.userName : ''}]]*/ '';
    const selectedRoomId = /*[[${selectedChatRoom != null ? selectedChatRoom.chatRoomId : ''}]]*/ '';
    const csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
    const csrfHeader = /*[[${_csrf != null ? _csrf.headerName : ''}]]*/ '';

    // 채팅방 목록 데이터
    const chatRooms = /*[[${allChatRooms}]]*/ [];

    console.log('Chat initialized with user:', currentUserId, currentUserName);
    console.log('Selected room:', selectedRoomId);
    console.log('Available chat rooms:', chatRooms?.length || 0);
    /*]]>*/
</script>

<!-- 채팅 기능 JavaScript 파일들 -->
<script th:src="@{/js/pages/chat.js}"></script>
<script th:src="@{/js/pages/chat-toggle.js}"></script>

</body>
</html>